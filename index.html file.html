<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Waktu Tunggu Pasien - All in One</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .card-custom {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header-custom {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .btn-custom {
            width: 100%;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.5);
        }

        .btn-back {
            background: #6c757d;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .antrian-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #2196F3;
        }

        .antrian-number {
            font-size: 48px;
            font-weight: 700;
            color: #2196F3;
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-menunggu {
            background: #fff3cd;
            color: #856404;
        }

        .status-dilayani {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-selesai {
            background: #d4edda;
            color: #155724;
        }

        .table-custom {
            width: 100%;
            margin-top: 20px;
        }

        .table-custom th {
            background: #f8f9fa;
            padding: 12px;
            font-weight: 700;
        }

        .table-custom td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #2196F3;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<!-- HALAMAN 1: MENU UTAMA -->
<div id="page-home" class="page active">
    <div class="main-container">
        <div class="card-custom">
            <div class="header-custom">
                <h1><i class="bi bi-hospital"></i> SISTEM MONITORING</h1>
                <h2>WAKTU TUNGGU PASIEN</h2>
            </div>

            <button class="btn-custom btn-primary-custom" onclick="showPage('cek-antrian')">
                <i class="bi bi-person-check"></i> CEK ANTRIAN SAYA
            </button>

            <button class="btn-custom btn-primary-custom" onclick="showPage('login')">
                <i class="bi bi-lock"></i> LOGIN PETUGAS
            </button>

            <button class="btn-custom btn-primary-custom" onclick="generateDemoData()">
                <i class="bi bi-database"></i> GENERATE DATA DEMO
            </button>

            <div id="demo-message" style="display:none;" class="alert-success mt-3">
                ‚úÖ Data demo berhasil di-generate! Silakan coba fitur-fitur sistem.
            </div>

            <div class="text-center mt-4 p-3" style="background: #f8f9fa; border-radius: 10px;">
                <strong>üìã Info Login Demo:</strong><br>
                <small>Pendaftaran: <code>pendaftaran / daftar123</code></small><br>
                <small>Dokter: <code>dokter / dokter123</code></small><br>
                <small>PMIK: <code>pmik / pmik123</code></small>
            </div>
        </div>
    </div>
</div>

<!-- HALAMAN 2: CEK ANTRIAN -->
<div id="page-cek-antrian" class="page">
    <div class="main-container">
        <div class="card-custom">
            <button class="btn-back" onclick="showPage('home')">
                <i class="bi bi-arrow-left"></i> Kembali
            </button>

            <div class="header-custom">
                <h2><i class="bi bi-search"></i> CEK ANTRIAN PASIEN</h2>
                <p>Masukkan No. Rekam Medis Anda</p>
            </div>

            <div class="mb-3">
                <label class="form-label">No. Rekam Medis</label>
                <input type="text" class="form-control" id="searchRM" placeholder="Contoh: RM001234">
            </div>

            <button class="btn btn-primary btn-lg w-100" onclick="cariAntrian()">
                <i class="bi bi-search"></i> Cari Antrian
            </button>

            <button class="btn btn-secondary btn-lg w-100 mt-2" onclick="lihatSemuaRM()">
                <i class="bi bi-list-ul"></i> Lihat Semua No. RM Hari Ini
            </button>

            <div id="error-cek" class="alert alert-danger mt-3" style="display:none;"></div>
            <div id="daftar-rm" style="display:none; margin-top: 30px;"></div>
            <div id="result-antrian" style="display:none; margin-top: 30px;"></div>
        </div>
    </div>
</div>

<!-- HALAMAN 3: LOGIN -->
<div id="page-login" class="page">
    <div class="main-container">
        <div class="card-custom">
            <button class="btn-back" onclick="showPage('home')">
                <i class="bi bi-arrow-left"></i> Kembali
            </button>

            <div class="header-custom">
                <h2><i class="bi bi-lock"></i> LOGIN PETUGAS</h2>
            </div>

            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" id="username" placeholder="Masukkan username">
            </div>

            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Masukkan password">
            </div>

            <div class="mb-3">
                <label class="form-label">Role</label>
                <select class="form-select" id="role">
                    <option value="">-- Pilih Role --</option>
                    <option value="pendaftaran">Petugas Pendaftaran</option>
                    <option value="dokter">Dokter / Petugas Poli</option>
                    <option value="pmik">Petugas PMIK</option>
                </select>
            </div>

            <button class="btn btn-primary btn-lg w-100" onclick="doLogin()">
                <i class="bi bi-box-arrow-in-right"></i> Login
            </button>

            <div id="error-login" class="alert alert-danger mt-3" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- HALAMAN 4: PENDAFTARAN PASIEN -->
<div id="page-pendaftaran" class="page">
    <div class="main-container">
        <div class="card-custom">
            <button class="btn-back" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i> Logout
            </button>

            <div class="header-custom">
                <h2><i class="bi bi-person-plus"></i> PENDAFTARAN PASIEN</h2>
                <p>Form Pendaftaran Pasien Rawat Jalan</p>
            </div>

            <div id="success-daftar" class="alert-success" style="display:none;"></div>

            <form id="formPendaftaran">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">No. Rekam Medis *</label>
                        <input type="text" class="form-control" name="noRM" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">NIK *</label>
                        <input type="text" class="form-control" name="nik" maxlength="16" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-control" name="namaLengkap" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tanggal Lahir *</label>
                        <input type="date" class="form-control" name="tanggalLahir" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Jenis Kelamin *</label>
                        <select class="form-select" name="jenisKelamin" required>
                            <option value="">-- Pilih --</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">No. Telepon *</label>
                        <input type="tel" class="form-control" name="noTelepon" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Alamat *</label>
                    <textarea class="form-control" name="alamat" rows="2" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Poli Tujuan *</label>
                        <select class="form-select" name="poliTujuan" required>
                            <option value="">-- Pilih Poli --</option>
                            <option value="Poli Umum">Poli Umum</option>
                            <option value="Poli Gigi">Poli Gigi</option>
                            <option value="Poli Anak">Poli Anak</option>
                            <option value="Poli Mata">Poli Mata</option>
                            <option value="Poli Kebidanan">Poli Kebidanan</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Pembayaran *</label>
                        <select class="form-select" name="jenisPembayaran" required>
                            <option value="">-- Pilih --</option>
                            <option value="BPJS">BPJS</option>
                            <option value="Umum">Umum</option>
                            <option value="Asuransi">Asuransi</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Keluhan</label>
                    <textarea class="form-control" name="keluhan" rows="2"></textarea>
                </div>

                <button type="submit" class="btn btn-success btn-lg w-100">
                    <i class="bi bi-check-circle"></i> Daftar Pasien
                </button>
            </form>
        </div>
    </div>
</div>

<!-- HALAMAN 5: DOKTER/POLI -->
<div id="page-dokter" class="page">
    <div class="main-container" style="max-width: 1200px;">
        <div class="card-custom">
            <button class="btn-back" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i> Logout
            </button>

            <div class="header-custom">
                <h2><i class="bi bi-clipboard-check"></i> PELAYANAN POLI</h2>
                <p>Daftar Antrian Pasien</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stat-box">
                        <div class="stat-number" id="stat-menunggu">0</div>
                        <div class="stat-label">Menunggu</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box">
                        <div class="stat-number" id="stat-dilayani">0</div>
                        <div class="stat-label">Dilayani</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box">
                        <div class="stat-number" id="stat-selesai">0</div>
                        <div class="stat-label">Selesai</div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Filter Poli:</label>
                <select class="form-select" id="filterPoli" onchange="loadDokterData()">
                    <option value="">Semua Poli</option>
                    <option value="Poli Umum">Poli Umum</option>
                    <option value="Poli Gigi">Poli Gigi</option>
                    <option value="Poli Anak">Poli Anak</option>
                    <option value="Poli Mata">Poli Mata</option>
                    <option value="Poli Kebidanan">Poli Kebidanan</option>
                </select>
            </div>

            <div id="table-dokter"></div>
        </div>
    </div>
</div>

<!-- HALAMAN 6: PMIK -->
<div id="page-pmik" class="page">
    <div class="main-container" style="max-width: 1200px;">
        <div class="card-custom">
            <button class="btn-back" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i> Logout
            </button>

            <div class="header-custom">
                <h2><i class="bi bi-graph-up"></i> DASHBOARD PMIK</h2>
                <p>Laporan Monitoring Waktu Tunggu</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-number" id="pmik-total">0</div>
                        <div class="stat-label">Total Pasien</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-number" id="pmik-avg">0</div>
                        <div class="stat-label">Rata-rata (menit)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-number" id="pmik-fastest">0</div>
                        <div class="stat-label">Tercepat (menit)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-number" id="pmik-slowest">0</div>
                        <div class="stat-label">Terlama (menit)</div>
                    </div>
                </div>
            </div>

            <div id="pmik-rekomendasi" class="alert alert-warning mb-4"></div>
            <div id="table-pmik"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// STATE MANAGEMENT
let currentUser = null;

// NAVIGATION
function showPage(pageName) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pageName).classList.add('active');
    
    // Load data when page shown
    if (pageName === 'dokter') loadDokterData();
    if (pageName === 'pmik') loadPMIKData();
}

// GENERATE DEMO DATA
function generateDemoData() {
    const today = new Date();
    const demoPatients = [];
    
    const patients = [
        // Poli Umum (6 pasien)
        {noRM: 'RM001234', nama: 'Budi Santoso', poli: 'Poli Umum', status: 'Selesai', waktuTunggu: 15},
        {noRM: 'RM001235', nama: 'Siti Aminah', poli: 'Poli Umum', status: 'Selesai', waktuTunggu: 22},
        {noRM: 'RM001236', nama: 'Ahmad Hidayat', poli: 'Poli Umum', status: 'Dilayani', waktuTunggu: null},
        {noRM: 'RM001237', nama: 'Rina Marlina', poli: 'Poli Umum', status: 'Menunggu', waktuTunggu: null},
        {noRM: 'RM001238', nama: 'Joko Widodo', poli: 'Poli Umum', status: 'Menunggu', waktuTunggu: null},
        {noRM: 'RM001239', nama: 'Mega Kartika', poli: 'Poli Umum', status: 'Menunggu', waktuTunggu: null},
        
        // Poli Gigi (4 pasien)
        {noRM: 'RM002101', nama: 'Dewi Lestari', poli: 'Poli Gigi', status: 'Selesai', waktuTunggu: 18},
        {noRM: 'RM002102', nama: 'Rudi Hermawan', poli: 'Poli Gigi', status: 'Dilayani', waktuTunggu: null},
        {noRM: 'RM002103', nama: 'Linda Suryani', poli: 'Poli Gigi', status: 'Menunggu', waktuTunggu: null},
        {noRM: 'RM002104', nama: 'Bambang Wijaya', poli: 'Poli Gigi', status: 'Menunggu', waktuTunggu: null},
        
        // Poli Anak (3 pasien)
        {noRM: 'RM003201', nama: 'Aditya Pratama', poli: 'Poli Anak', status: 'Selesai', waktuTunggu: 12},
        {noRM: 'RM003202', nama: 'Zahra Amelia', poli: 'Poli Anak', status: 'Menunggu', waktuTunggu: null},
        {noRM: 'RM003203', nama: 'Fahri Rahman', poli: 'Poli Anak', status: 'Menunggu', waktuTunggu: null},
        
        // Poli Mata (3 pasien)
        {noRM: 'RM004301', nama: 'Rina Kusuma', poli: 'Poli Mata', status: 'Dilayani', waktuTunggu: null},
        {noRM: 'RM004302', nama: 'Anton Wijaya', poli: 'Poli Mata', status: 'Menunggu', waktuTunggu: null},
        {noRM: 'RM004303', nama: 'Sri Mulyani', poli: 'Poli Mata', status: 'Menunggu', waktuTunggu: null},
        
        // Poli Kebidanan (4 pasien)
        {noRM: 'RM005401', nama: 'Wulan Sari', poli: 'Poli Kebidanan', status: 'Selesai', waktuTunggu: 25},
        {noRM: 'RM005402', nama: 'Ratna Dewi', poli: 'Poli Kebidanan', status: 'Dilayani', waktuTunggu: null},
        {noRM: 'RM005403', nama: 'Indah Permata', poli: 'Poli Kebidanan', status: 'Menunggu', waktuTunggu: null},
        {noRM: 'RM005404', nama: 'Sari Rahayu', poli: 'Poli Kebidanan', status: 'Menunggu', waktuTunggu: null},
    ];

    const poliCodes = {'Poli Umum': 'A', 'Poli Gigi': 'B', 'Poli Anak': 'C', 'Poli Mata': 'D', 'Poli Kebidanan': 'E'};
    const poliCounters = {};

    patients.forEach((p, idx) => {
        if (!poliCounters[p.poli]) poliCounters[p.poli] = 0;
        poliCounters[p.poli]++;
        
        const waktuDaftar = new Date(today);
        waktuDaftar.setHours(8, idx * 15, 0);
        
        const data = {
            id: 'P' + Date.now() + idx,
            nomorAntrian: poliCodes[p.poli] + String(poliCounters[p.poli]).padStart(3, '0'),
            noRM: p.noRM,
            nik: '320123456789000' + idx,
            namaLengkap: p.nama,
            tanggalLahir: '1985-05-15',
            jenisKelamin: idx % 2 === 0 ? 'L' : 'P',
            noTelepon: '08123456789' + idx,
            alamat: 'Jl. Test No. ' + idx,
            poliTujuan: p.poli,
            jenisPembayaran: idx % 3 === 0 ? 'BPJS' : 'Umum',
            keluhan: 'Keluhan pasien ' + idx,
            waktuDaftar: waktuDaftar.toISOString(),
            status: p.status
        };

        if (p.status === 'Dilayani') {
            const waktuMulai = new Date(waktuDaftar);
            waktuMulai.setMinutes(waktuMulai.getMinutes() + 5);
            data.waktuMulaiLayanan = waktuMulai.toISOString();
        }

        if (p.status === 'Selesai') {
            const waktuMulai = new Date(waktuDaftar);
            waktuMulai.setMinutes(waktuMulai.getMinutes() + p.waktuTunggu);
            data.waktuMulaiLayanan = waktuMulai.toISOString();
            data.waktuSelesai = new Date(waktuMulai).toISOString();
            data.waktuTungguMenit = p.waktuTunggu;
        }

        demoPatients.push(data);
    });

    localStorage.setItem('patients', JSON.stringify(demoPatients));
    document.getElementById('demo-message').style.display = 'block';
    setTimeout(() => {
        document.getElementById('demo-message').style.display = 'none';
    }, 3000);
}

// CEK ANTRIAN
function cariAntrian() {
    const noRM = document.getElementById('searchRM').value.trim();
    const patients = JSON.parse(localStorage.getItem('patients')) || [];
    const today = new Date().toDateString();
    
    const patient = patients.find(p => {
        const patientDate = new Date(p.waktuDaftar).toDateString();
        return p.noRM === noRM && patientDate === today;
    });

    const errorDiv = document.getElementById('error-cek');
    const resultDiv = document.getElementById('result-antrian');
    const daftarDiv = document.getElementById('daftar-rm');

    // Sembunyikan daftar RM saat search
    daftarDiv.style.display = 'none';

    if (!patient) {
        errorDiv.textContent = '‚ùå No. RM tidak ditemukan atau belum terdaftar hari ini.';
        errorDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        return;
    }

    errorDiv.style.display = 'none';
    
    const poliPatients = patients.filter(p => {
        const patientDate = new Date(p.waktuDaftar).toDateString();
        return patientDate === today && p.poliTujuan === patient.poliTujuan && p.status === 'Menunggu';
    });

    const patientIndex = poliPatients.findIndex(p => p.id === patient.id);
    const sisaAntrian = patientIndex >= 0 ? patientIndex : 0;
    const estimasi = sisaAntrian * 10;

    const waktuDaftar = new Date(patient.waktuDaftar).toLocaleTimeString('id-ID', {
        hour: '2-digit', minute: '2-digit'
    });

    resultDiv.innerHTML = `
        <div class="antrian-card">
            <div class="antrian-number">${patient.nomorAntrian}</div>
            <h4 class="text-center mt-3">${patient.namaLengkap}</h4>
            <p class="text-center"><span class="status-badge status-${patient.status.toLowerCase()}">${patient.status}</span></p>
            
            <hr>
            
            <div class="row text-center">
                <div class="col-md-4">
                    <strong>Poli</strong><br>
                    <span class="text-muted">${patient.poliTujuan}</span>
                </div>
                <div class="col-md-4">
                    <strong>Sisa Antrian</strong><br>
                    <span class="text-muted">${patient.status === 'Menunggu' ? sisaAntrian + ' pasien' : '-'}</span>
                </div>
                <div class="col-md-4">
                    <strong>Estimasi</strong><br>
                    <span class="text-muted">${patient.status === 'Menunggu' ? '~ ' + estimasi + ' menit' : '-'}</span>
                </div>
            </div>
        </div>
    `;
    resultDiv.style.display = 'block';
}

// LIHAT SEMUA NO. RM
function lihatSemuaRM() {
    const patients = JSON.parse(localStorage.getItem('patients')) || [];
    const today = new Date().toDateString();
    
    const todayPatients = patients.filter(p => {
        const patientDate = new Date(p.waktuDaftar).toDateString();
        return patientDate === today;
    });

    const errorDiv = document.getElementById('error-cek');
    const resultDiv = document.getElementById('result-antrian');
    const daftarDiv = document.getElementById('daftar-rm');

    // Sembunyikan hasil pencarian saat melihat daftar
    resultDiv.style.display = 'none';
    errorDiv.style.display = 'none';

    if (todayPatients.length === 0) {
        errorDiv.textContent = '‚ö†Ô∏è Belum ada pasien yang terdaftar hari ini. Klik "Generate Data Demo" di halaman utama.';
        errorDiv.style.display = 'block';
        daftarDiv.style.display = 'none';
        return;
    }

    // Kelompokkan berdasarkan poli
    const byPoli = {};
    todayPatients.forEach(p => {
        if (!byPoli[p.poliTujuan]) byPoli[p.poliTujuan] = [];
        byPoli[p.poliTujuan].push(p);
    });

    let html = '<div class="alert alert-info"><strong><i class="bi bi-info-circle"></i> Daftar No. RM Hari Ini</strong><br>Klik pada No. RM untuk melihat detail antrian</div>';

    Object.keys(byPoli).sort().forEach(poli => {
        html += `
            <div class="mb-4">
                <h5 class="mb-3" style="color: #2196F3; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">
                    <i class="bi bi-hospital"></i> ${poli}
                </h5>
                <div class="row">
        `;

        byPoli[poli].forEach(p => {
            const statusColor = p.status === 'Menunggu' ? '#ffc107' : p.status === 'Dilayani' ? '#17a2b8' : '#28a745';
            const statusIcon = p.status === 'Menunggu' ? 'hourglass-split' : p.status === 'Dilayani' ? 'person-check' : 'check-circle';
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card" style="cursor: pointer; border-left: 4px solid ${statusColor};" onclick="pilihRM('${p.noRM}')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1" style="color: #2196F3; font-weight: bold;">
                                        <i class="bi bi-card-text"></i> ${p.noRM}
                                    </h6>
                                    <p class="mb-1" style="font-size: 0.9em; color: #333;">
                                        <strong>${p.namaLengkap}</strong>
                                    </p>
                                    <p class="mb-0" style="font-size: 0.85em; color: #666;">
                                        Antrian: <strong>${p.nomorAntrian}</strong>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <span class="badge" style="background-color: ${statusColor}; font-size: 0.75em;">
                                        <i class="bi bi-${statusIcon}"></i> ${p.status}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    });

    html += `
        <div class="text-center mt-4">
            <p class="text-muted"><i class="bi bi-info-circle"></i> Total: <strong>${todayPatients.length}</strong> pasien terdaftar hari ini</p>
        </div>
    `;

    daftarDiv.innerHTML = html;
    daftarDiv.style.display = 'block';
}

// PILIH NO. RM DARI DAFTAR
function pilihRM(noRM) {
    document.getElementById('searchRM').value = noRM;
    cariAntrian();
    // Scroll ke hasil
    document.getElementById('result-antrian').scrollIntoView({ behavior: 'smooth' });
}

// LOGIN
function doLogin() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    const errorDiv = document.getElementById('error-login');

    const validUsers = {
        'pendaftaran': { password: 'daftar123', page: 'pendaftaran' },
        'dokter': { password: 'dokter123', page: 'dokter' },
        'pmik': { password: 'pmik123', page: 'pmik' }
    };

    if (validUsers[username] && validUsers[username].password === password && role === username) {
        currentUser = { username, role };
        showPage(validUsers[username].page);
        errorDiv.style.display = 'none';
    } else {
        errorDiv.textContent = '‚ùå Username, password, atau role tidak sesuai!';
        errorDiv.style.display = 'block';
    }
}

function logout() {
    currentUser = null;
    showPage('home');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('role').value = '';
}

// PENDAFTARAN
document.getElementById('formPendaftaran').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const poli = formData.get('poliTujuan');
    
    const patients = JSON.parse(localStorage.getItem('patients')) || [];
    const today = new Date().toDateString();
    const poliPatients = patients.filter(p => {
        const patientDate = new Date(p.waktuDaftar).toDateString();
        return patientDate === today && p.poliTujuan === poli;
    });
    
    const poliCodes = {'Poli Umum': 'A', 'Poli Gigi': 'B', 'Poli Anak': 'C', 'Poli Mata': 'D', 'Poli Kebidanan': 'E'};
    const nomorAntrian = poliCodes[poli] + String(poliPatients.length + 1).padStart(3, '0');
    
    const data = {
        id: 'P' + Date.now(),
        nomorAntrian: nomorAntrian,
        noRM: formData.get('noRM'),
        nik: formData.get('nik'),
        namaLengkap: formData.get('namaLengkap'),
        tanggalLahir: formData.get('tanggalLahir'),
        jenisKelamin: formData.get('jenisKelamin'),
        noTelepon: formData.get('noTelepon'),
        alamat: formData.get('alamat'),
        poliTujuan: poli,
        jenisPembayaran: formData.get('jenisPembayaran'),
        keluhan: formData.get('keluhan'),
        waktuDaftar: new Date().toISOString(),
        status: 'Menunggu'
    };
    
    patients.push(data);
    localStorage.setItem('patients', JSON.stringify(patients));
    
    const successDiv = document.getElementById('success-daftar');
    successDiv.innerHTML = `‚úÖ Pasien <strong>${data.namaLengkap}</strong> berhasil didaftarkan!<br>Nomor Antrian: <strong>${nomorAntrian}</strong>`;
    successDiv.style.display = 'block';
    
    this.reset();
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 5000);
});

// DOKTER
function loadDokterData() {
    const patients = JSON.parse(localStorage.getItem('patients')) || [];
    const today = new Date().toDateString();
    const filterPoli = document.getElementById('filterPoli').value;
    
    let filtered = patients.filter(p => {
        const patientDate = new Date(p.waktuDaftar).toDateString();
        return patientDate === today && (!filterPoli || p.poliTujuan === filterPoli);
    });

    const menunggu = filtered.filter(p => p.status === 'Menunggu').length;
    const dilayani = filtered.filter(p => p.status === 'Dilayani').length;
    const selesai = filtered.filter(p => p.status === 'Selesai').length;

    document.getElementById('stat-menunggu').textContent = menunggu;
    document.getElementById('stat-dilayani').textContent = dilayani;
    document.getElementById('stat-selesai').textContent = selesai;

    filtered.sort((a, b) => {
        const statusOrder = { 'Dilayani': 1, 'Menunggu': 2, 'Selesai': 3 };
        return statusOrder[a.status] - statusOrder[b.status];
    });

    let html = '<table class="table table-striped"><thead><tr><th>No. Antrian</th><th>Nama</th><th>Poli</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
    
    filtered.forEach(p => {
        const statusClass = p.status === 'Menunggu' ? 'status-menunggu' : p.status === 'Dilayani' ? 'status-dilayani' : 'status-selesai';
        let actionBtn = '';
        
        if (p.status === 'Menunggu') {
            actionBtn = `<button class="btn btn-sm btn-primary" onclick="layaniPasien('${p.id}')">Layani</button>`;
        } else if (p.status === 'Dilayani') {
            actionBtn = `<button class="btn btn-sm btn-success" onclick="selesaiPasien('${p.id}')">Selesai</button>`;
        }
        
        html += `<tr>
            <td><strong>${p.nomorAntrian}</strong></td>
            <td>${p.namaLengkap}</td>
            <td>${p.poliTujuan}</td>
            <td><span class="status-badge ${statusClass}">${p.status}</span></td>
            <td>${actionBtn}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    document.getElementById('table-dokter').innerHTML = html;
}

function layaniPasien(id) {
    let patients = JSON.parse(localStorage.getItem('patients')) || [];
    patients = patients.map(p => {
        if (p.id === id) {
            return { ...p, status: 'Dilayani', waktuMulaiLayanan: new Date().toISOString() };
        }
        return p;
    });
    localStorage.setItem('patients', JSON.stringify(patients));
    loadDokterData();
}

function selesaiPasien(id) {
    let patients = JSON.parse(localStorage.getItem('patients')) || [];
    patients = patients.map(p => {
        if (p.id === id) {
            const waktuMulai = new Date(p.waktuMulaiLayanan || p.waktuDaftar);
            const waktuTunggu = Math.floor((waktuMulai - new Date(p.waktuDaftar)) / (1000 * 60));
            return { 
                ...p, 
                status: 'Selesai', 
                waktuSelesai: new Date().toISOString(),
                waktuTungguMenit: waktuTunggu
            };
        }
        return p;
    });
    localStorage.setItem('patients', JSON.stringify(patients));
    loadDokterData();
}

// PMIK
function loadPMIKData() {
    const patients = JSON.parse(localStorage.getItem('patients')) || [];
    const today = new Date().toDateString();
    
    const selesai = patients.filter(p => {
        const patientDate = new Date(p.waktuDaftar).toDateString();
        return patientDate === today && p.status === 'Selesai' && p.waktuTungguMenit;
    });

    if (selesai.length === 0) {
        document.getElementById('pmik-total').textContent = '0';
        document.getElementById('pmik-avg').textContent = '0';
        document.getElementById('pmik-fastest').textContent = '0';
        document.getElementById('pmik-slowest').textContent = '0';
        document.getElementById('pmik-rekomendasi').innerHTML = '<strong>‚ö†Ô∏è Belum ada data pasien selesai.</strong>';
        document.getElementById('table-pmik').innerHTML = '<p class="text-center">Tidak ada data.</p>';
        return;
    }

    const times = selesai.map(p => p.waktuTungguMenit);
    const total = selesai.length;
    const avg = Math.round(times.reduce((a,b) => a+b, 0) / total);
    const fastest = Math.min(...times);
    const slowest = Math.max(...times);

    document.getElementById('pmik-total').textContent = total;
    document.getElementById('pmik-avg').textContent = avg;
    document.getElementById('pmik-fastest').textContent = fastest;
    document.getElementById('pmik-slowest').textContent = slowest;

    // Rekomendasi
    let rekomendasi = '<strong>üìä Rekomendasi:</strong><ul>';
    if (avg > 30) rekomendasi += '<li>Rata-rata waktu tunggu melebihi target 30 menit.</li>';
    if (slowest > 60) rekomendasi += '<li>Terdapat pasien menunggu lebih dari 1 jam.</li>';
    if (rekomendasi === '<strong>üìä Rekomendasi:</strong><ul>') rekomendasi += '<li>‚úÖ Performa pelayanan sudah baik!</li>';
    rekomendasi += '</ul>';
    document.getElementById('pmik-rekomendasi').innerHTML = rekomendasi;

    // Tabel
    let html = '<table class="table table-striped"><thead><tr><th>No. Antrian</th><th>Nama</th><th>Poli</th><th>Waktu Tunggu</th><th>Ket</th></tr></thead><tbody>';
    selesai.forEach(p => {
        const timeClass = p.waktuTungguMenit < 20 ? 'text-success' : p.waktuTungguMenit < 40 ? 'text-warning' : 'text-danger';
        const ket = p.waktuTungguMenit < 20 ? 'Baik' : p.waktuTungguMenit < 40 ? 'Cukup' : 'Perlu Perbaikan';
        html += `<tr>
            <td>${p.nomorAntrian}</td>
            <td>${p.namaLengkap}</td>
            <td>${p.poliTujuan}</td>
            <td class="${timeClass}"><strong>${p.waktuTungguMenit} menit</strong></td>
            <td>${ket}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('table-pmik').innerHTML = html;
}

// Init: Check localStorage support
try {
    localStorage.setItem('test', 'test');
    localStorage.removeItem('test');
} catch(e) {
    alert('Browser Anda tidak mendukung localStorage. Gunakan browser modern.');
}
</script>
</body>
</html>
